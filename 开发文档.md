# FS服装搭配专家v1.0 开发文档

## 项目概述

FS服装搭配专家v1.0是一个用于街头篮球游戏服装搭配的工具，允许用户浏览、选择和搭配游戏中的服装物品。

**项目目录**：D:\py\反编译\FreeStyle

## 技术栈

- .NET 8.0 Windows Presentation Foundation (WPF)
- C#
- XAML
- 外部工具：UnFSPak (resources.exe) 用于提取游戏数据

## 编译配置

- 目标框架：.NET 8.0 Windows
- 输出目录：`bin\Debug\net8.0-windows`
- 注意：项目使用的是.NET 8.0，不是.NET 10，因此编译输出目录是`net8.0-windows`，不是`net10`

## 主要修改和修复

### 1. 路径加载和配置问题

**问题**：应用程序启动时没有询问加载路径，且无法正确加载游戏数据

**解决方案**：
- 增强了`InitializeConfig`方法，确保正确加载和保存配置文件
- 添加了路径验证逻辑，确保游戏安装目录存在且包含必要的文件
- 修改了路径构造方式，使用`AppDomain.CurrentDomain.BaseDirectory`代替`Environment.CurrentDirectory`，确保应用程序使用正确的目录路径

### 2. Pak文件提取问题

**问题**：`UnFSPak`工具(resources.exe)无法正确提取`item_text.pak`文件

**解决方案**：
- 确保`pack`目录包含`resources.exe`工具
- 修复了提取命令的路径构造，使用`Path.Combine`确保路径格式正确
- 添加了文件操作重试逻辑，处理文件锁定情况

### 3. 文件存在性检查问题

**问题**：`File.Exists`检查在某些情况下返回错误的结果，导致应用程序无法读取已存在的文件

**解决方案**：
- 移除了`File.Exists`检查，改为直接使用`using`语句打开文件
- 添加了异常处理，捕获文件不存在等错误情况
- 使用`using`语句确保资源正确释放，避免资源泄漏

### 4. 应用程序启动崩溃问题

**问题**：应用程序启动时崩溃，无法正常初始化

**解决方案**：
- 将数据加载从构造函数移到`Loaded`事件的后台线程中
- 添加了更详细的日志记录，便于调试和问题定位
- 优化了窗口初始化流程，确保UI元素正确加载

### 5. 图片加载问题

**问题**：点击加载图片按钮时出现错误，无法加载服装图片

**解决方案**：
- 修复了`LoadImages`方法中的路径构建问题
- 添加了自动加载服装数据的逻辑，如果列表为空
- 优化了图片加载流程，确保正确处理路径和文件存在性

### 6. 加载性能优化

**问题**：服装数据加载速度比原始源代码慢

**解决方案**：
- 移除了大量日志记录代码，减少I/O操作
- 优化了文件操作和重试逻辑，减少等待时间
- 实现了静默加载，移除了加载提示，提高了用户体验

### 7. 窗口大小设置问题

**问题**：尝试将窗口大小设置为1440x1080，但修改未生效

**解决方案**：
- 修改了`MainWindow.xaml`文件，将窗口大小从1400x720改为1440x1080
- 修改了`MainWindow.xaml.cs`文件，将构造函数中的窗口大小从1440x968改为1440x1080
- 重新编译了项目，但窗口大小修改仍然未生效

**待解决**：窗口大小设置问题需要进一步调查，可能需要检查XAML和代码中的其他地方是否有覆盖窗口大小的设置

### 8. 服装列表显示乱码问题

**问题**：服装列表中的中文显示为乱码

**原因分析**：编码处理问题，itemshop.txt文件读取时的编码设置不正确

**根本原因**：
- itemshop.txt文件是GBK/GB2312编码，不是Big5编码
- v1.0错误地使用`Encoding.GetEncoding(950)`（Big5）读取文件
- v5.3.6源代码使用`Encoding.Default`读取文件，正常显示中文

**解决方案**：
- 注册编码提供程序：`Encoding.RegisterProvider(CodePagesEncodingProvider.Instance)`
- 使用GB2312编码读取文件：`Encoding.GetEncoding("GB2312")`
- 这是因为.NET 8.0中`Encoding.Default`是UTF-8，需要显式指定GB2312编码

**当前状态**：✅ 问题已解决

### 9. 实时搜索功能

**功能描述**：在搜索框中输入关键字，服装列表实时显示匹配的结果

**实现方式**：
- 使用`txtSearch_TextChanged`事件触发实时搜索
- 搜索范围包括：ItemCode、PakNum、EffectCode、ItemName、Comment、ItemType
- 使用`StringComparison.OrdinalIgnoreCase`进行不区分大小写的搜索
- 清空搜索框时恢复显示全部服装

**当前状态**：✅ 功能已实现

### 10. 服装选择功能

**功能描述**：
- 左键点击服装：添加到"变更前"列表
- Ctrl+左键点击服装：添加到"变更后"列表
- 点击已添加的服装：从列表中移除
- 确认变更：将配对的服装变更记录到dopaklog.ini
- 清空所有：清空变更前和变更后的服装列表
- 显示服装图标：变更前后区域显示服装图标而非文本
- 鼠标悬停提示：显示服装名称

**实现方式**：
- 使用`lstClothing_SelectionChanged`事件处理服装选择
- 通过`Keyboard.Modifiers`检测Ctrl键状态
- 使用`beforeItems`和`afterItems`列表存储选中的服装
- 动态更新UI面板显示选中的服装图标
- 使用`BitmapImage`加载图标，设置`CacheOption.OnLoad`避免文件锁定
- 配对状态显示已配对的服装数量

**当前状态**：✅ 功能已实现

### 11. 加载图片按钮

**功能描述**：
- 解包icon pak文件，加载服装图标
- 位置：搜索框右侧
- 支持解包cookies目录下已有的pak文件
- 支持从游戏目录复制缺失的pak文件并解包

**实现方式**：
- 在XAML中添加按钮，使用`WindowButton`样式
- 点击触发`btnLoadImg_Click`事件
- 先解包cookies目录下所有已有的icon*.pak文件
- 再检查服装列表中缺失的pak文件并从游戏目录复制解包
- 使用`conmon.RunCmd`执行解包命令

**关键代码**：
- `RunCmd`方法使用`StandardInput.WriteLine`执行命令（与v5.3.6一致）
- 解包命令：`pack\resources "pak文件路径" -byname .+\.png`

**当前状态**：✅ 功能已实现

### 12. 窗口最大化功能

**功能描述**：程序启动时自动最大化窗口

**实现方式**：
- 在XAML中设置`WindowState="Maximized"`
- 在代码中设置`this.WindowState = WindowState.Maximized`

**当前状态**：✅ 功能已实现

### 13. 服装变更功能

**功能描述**：
- 确认变更：执行实际的服装替换操作
- 批量变更：支持同时变更多件服装
- 变更记录：记录变更历史到dopaklog.ini
- 自动解包：选择服装时自动解包对应的item pak文件

**实现方式**：
- 选择服装时自动解包对应的item pak文件（UnpackItemPak方法）
- 复制服装模型文件（.bml）到目标item pak目录
- 使用resources.exe -file2pak打包回游戏目录
- 记录变更日志到dopaklog.ini

**核心流程**：
1. 选择服装时检查并解包对应的item pak文件
2. 确认变更时复制源服装模型文件到目标位置
3. 使用resources.exe -file2pak将目录打包回游戏pak文件
4. 记录变更日志

**关键问题：PakNum字段处理**：

`PakNum`字段格式为`*747.pak`（包含`*`前缀和`.pak`后缀），需要正确转换：

| 用途 | 转换方式 | 示例 |
|------|----------|------|
| pak文件名 | `item` + PakNum.Replace("*", "") | item747.pak |
| 解包目录名 | pak文件名.Replace(".", "_") | item747_pak |
| 游戏目录pak路径 | 游戏目录 + `\` + pak文件名 | C:\...\item747.pak |

**路径引号问题**：

游戏安装路径包含空格（如`C:\Program Files (x86)\...`），必须给路径加引号：

```csharp
// 正确：使用引号包裹路径
string cmd = "pack\\resources -file2pak \"" + beforePakDir + "\" \"" + pakPath + "\"";

// 错误：路径中的空格会导致参数解析错误
string cmd = "pack\\resources -file2pak " + beforePakDir + " " + pakPath;
```

**当前状态**：✅ 功能已实现

## 目录结构

```
D:\py\反编译\FreeStyle\
├── bin\Debug\net8.0-windows\  # 编译输出目录
│   ├── cookies\              # 游戏数据目录
│   │   ├── item_text.pak      # 游戏物品数据文件
│   │   └── item_text_pak\     # 提取后的数据文件
│   ├── pack\                 # 工具目录
│   │   └── resources.exe      # UnFSPak工具
│   └── FS服装搭配专家v1.0.exe  # 可执行文件
├── UI\                        # UI相关代码
│   ├── Windows\               # 窗口代码
│   │   └── MainWindow.xaml.cs  # 主窗口代码
├── Core\                      # 核心代码
├── FS服装搭配专家v1.0.csproj   # 项目配置文件
├── config.ini                  # 配置文件
└── 开发文档.md                  # 本开发文档
```

## 配置文件

配置文件`config.ini`用于存储游戏安装目录路径：

```ini
[Config]
InstallDirectory=C:\Program Files (x86)\T2CN\街头篮球
```

## 编译和运行

### 编译步骤

1. 打开命令行工具，进入项目目录：`cd D:\py\反编译\FreeStyle`
2. 执行编译命令：`dotnet build`
3. 编译成功后，可执行文件将生成在`bin\Debug\net8.0-windows`目录

### 运行步骤

1. 确保`config.ini`文件中设置了正确的游戏安装目录
2. 确保`pack`目录包含`resources.exe`工具
3. 运行`FS服装搭配专家v1.0.exe`可执行文件

## 常见问题和解决方案

### 1. 无法找到游戏安装目录

**症状**：应用程序启动时提示无法找到游戏安装目录

**解决方案**：
- 确保`config.ini`文件存在且包含正确的游戏安装目录路径
- 手动选择游戏安装目录，应用程序会自动保存到`config.ini`

### 2. 无法提取Pak文件

**症状**：应用程序提示无法提取`item_text.pak`文件

**解决方案**：
- 确保`pack`目录包含`resources.exe`工具
- 确保游戏安装目录包含`item_text.pak`文件
- 检查文件权限，确保应用程序有读取和写入权限

### 3. 无法加载图片

**症状**：点击加载图片按钮时出现错误

**解决方案**：
- 确保游戏安装目录包含必要的图片文件
- 确保应用程序有读取图片文件的权限
- 检查网络连接，某些图片可能需要从网络加载

## 日志文件

应用程序生成以下日志文件，用于调试和问题定位：

- `startup.log`：应用程序启动日志
- `init.log`：初始化日志
- `getnewitem.log`：服装数据加载日志
- `mainwindow.log`：主窗口日志

## 注意事项

1. 应用程序需要.NET 8.0运行时环境
2. 确保游戏安装目录包含必要的游戏数据文件
3. 定期备份`config.ini`文件，避免配置丢失
4. 如果遇到问题，查看日志文件获取详细信息

## 项目状态

✅ **已完成**：应用程序可以成功启动，加载游戏数据
✅ **已修复**：图片加载功能正常工作
✅ **已优化**：应用程序启动速度和稳定性得到提升
✅ **已修复**：服装列表显示乱码问题（2026年2月26日）
✅ **已实现**：实时搜索功能（2026年2月26日）
✅ **已实现**：服装选择功能，显示服装图标（2026年2月26日）
✅ **已实现**：加载图片按钮（2026年2月26日）
✅ **已实现**：窗口最大化功能（2026年2月26日）
✅ **已实现**：服装变更和批量变更功能（2026年2月26日）
✅ **已修复**：图片解包功能，使用与v5.3.6一致的RunCmd方法（2026年2月27日）
✅ **已实现**：item pak自动解包功能，选择服装时自动解包（2026年2月27日）
✅ **已实现**：变更功能完整实现，使用-file2pak打包回游戏目录（2026年2月27日）
✅ **已修复**：PakNum字段处理问题，正确移除`*`和`.pak`后缀（2026年2月27日）
✅ **已修复**：目录名格式统一为`itemXXX_pak`（2026年2月27日）
✅ **已更新**：确认对话框样式，改为横向显示，减小字体大小，调整为灰白底色和紫色文字（2026年2月28日）

---

**最后更新时间**：2026年2月28日
**更新人**：AI Assistant
